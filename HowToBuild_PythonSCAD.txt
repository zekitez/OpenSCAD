###########################################
#
# In this file I keep my notes on building PythonSCAD with some patches based on Debian (Ubuntu, Mint).
# Building environment: Linux Ubuntu 24.04 Cinnamon (no problem), 
#                       Linux Debian 13.2 Cinnamon  (replacement for Linux Mint) and 
#                       MinGW-w64 on Windows 11.
#
# You still will find build issues. Sometimes you have to kill an xTerm and start again with a fresh xTerm...
# Cross compiling PythonSCAD on Linux for Windows currently fails (2025-12-19).
# Only building on Linux for Linux works. 
# During building you will be faced with missing Linux packages. Use Google to find out how to install them.
# Building on a Windows machine using MinGW-w64 is not tried.
#
# Just copy line by line and paste each line in an xterm.
#
# Note: While cross compiling on Linux for Windows an ~/openscad_deps is created. 
# The one created for openscad differs from the one for pythonscad.
# They don't mix.
#
# Currently cross compiling PythonSCAD for Windows fails. Frist clipper2, then on tbb and now on "too many sections" with 'file too big'.
#
# This file is probably behind the current pythonscad version.
# Thus compiling or creating an AppImage or Cross Compiling for Windows may fail.
# The build of PythonSCAD sometimes breaks after a "git pull". Save your changed code before pulling !!!
# The solution is to delete the pythonscad directory and clone it again and start from there again.
#
###########################################
# For pythodscad bsdtar is needed:
# https://www.linuxfromscratch.org/blfs/view/svn/general/libarchive.html

sudo apt update
sudo apt upgrade
sudo apt install libarchive-tools git wget 

$ bsdtar
bsdtar: Must specify one of -c, -r, -t, -u, -x    

# If you do not get the previous text then continue with:
wget https://github.com/libarchive/libarchive/releases/download/v3.8.4/libarchive-3.8.4.tar.gz

gunzip libarchive-3.8.4.tar.gz      # --> libarchive-3.8.4.tar
tar -xvf libarchive-3.8.4.tar       # --> libarchive-3.8.4

./configure --prefix=/usr --disable-static && make

make check

sudo make install

#################################################
# Get the pythonscad code:

git clone https://github.com/pythonscad/pythonscad.git
cd pythonscad
git submodule update --init --recursive

sudo ./scripts/uni-get-dependencies.py --profile pythonscad-qt5

# Install some required packages and check them.
sudo ./scripts/uni-get-dependencies.sh
./scripts/check-dependencies.sh

# In case of missing packages: install them.
# One might be Preferred:
# sudo apt-get install libcurl4-openssl-dev
# or
# sudo apt-get install libcurl4-gnutls-dev
# or
# sudo apt-get install libcurl4-nss-dev


#########################################
# Get the pached code and overwrite the pythonscad code.
# Do this step after a 1st succesfull building step and then repeat the building step.

wget https://github.com/zekitez/OpenSCAD/archive/refs/heads/main.zip
unzip main.zip

# Option: diff the file, example: diff ./locale/openscad.pot OpenSCAD-main/locale/openscad.pot

# Dangerous but...
cp -rpP OpenSCAD-main/src/* ./src/.
### cp -rpP OpenSCAD-main/scripts/* ./scripts/  # Not
cp -rpP OpenSCAD-main/locale/* ./locale/

# In PythonSCAD src/gui/Preferences.* differs from OpenSCAD. Thus:
cp -rpP OpenSCAD-main/pythonscad/src/gui/Preferences.* ./src/gui/

chmod +x ./scripts/*
cmake --build build -t clean
cd ./build
make -j8

#########################################
#  Build step for a Linux executable building on Linux in the cloned pythonscad directory:

rm -rf build AppDir
mkdir build

# Get latest files from PythonSCAD master
git pull

# If you did not delete the build then clean it before a new build.
cmake --build build -t clean

# *** If there is a ~/openscad_deps then move it to ~/openscad_deps_ORG or the next cmake will fail !!!
# ***
if [ -d ~/openscad_deps ]; then mv ~/openscad_deps ~/openscad_deps_ORG; fi

# Once only with a new build directory or to change options  do:
cmake -B build \
      -DEXPERIMENTAL=ON \
      -DENABLE_PYTHON=ON \
      -DSNAPSHOT=ON 

# Generates an executable, with make -j8, which has 70830144 bytes.
# 64780 -rwxrwxr-x  1 db811 db811  70830144 Dec 11 14:04 pythonscad             <-----
# For a smaller version see below.

# Use 8 cores to make, depends on the CPU cores, 
# Use without the -jn option (slow), or with n = 4 or 6 or ..(faster). See my Log_make_-j8.txt.
cd build
make -j8

# Run from the build directory with:
./pythonscad

# Optional, install it on this computer with in /usr/bin : 
# sudo make install        
# Or optional, install it on this computer with in /usr/bin : 
# cd ..
# sudo cmake --install build
# Check /usr for an installed pythonscad file...

# For generating an AppImage you need to do in the build directory:
make install DESTDIR=../AppDir    # See Log_make_install_DESTDIR.txt
cd ..

ln -s ./build/pythonscad .

# This build is not suited for making an AppImage.
# I noticed it installs all in  ../AppDir/usr/local/*   an additional "local" directory.
# The next build installs in   ../AppDir/usr/*
# Could be  -DCMAKE_INSTALL_PREFIX=/usr \

####################################################
#  Build step for a Linux executable and/or an AppDir for an Linux AppImage building on Linux in the cloned pythonscad directory:

rm -rf build AppDir
mkdir build

# Get latest files from pythonscad master
git pull

. ./scripts/establish_version.sh
export OPENSCAD_VERSION=$(openscad_version)
export OPENSCAD_COMMIT=$(openscad_commit)

cmake -B build \
                  -DOPENSCAD_VERSION="$OPENSCAD_VERSION" \
                  -DOPENSCAD_COMMIT="$OPENSCAD_COMMIT" \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_BUILD_TYPE=Release \
                  -DUSE_BUILTIN_OPENCSG=ON \
                  -DMANIFOLD_PYBIND=OFF \
                  -DMANIFOLD_TEST=OFF \
                  -DENABLE_PYTHON=ON \
                  -DENABLE_TESTS=OFF \
                  -DEXPERIMENTAL=ON \
                  -DSNAPSHOT=ON

cd build
make -j8

# Generates an executable which has not 70830144 but 22372728 bytes.
# 69172 -rwxrwxr-x  1 db811 db811  22372728 Dec 13 13:04 pythonscad            <-----

# Run from the build directory with:
./pythonscad

# For generating an AppImage you need to do:
make install DESTDIR=../AppDir 

cd ..
ln -s ./build/pythonscad .

# AppImage creation may fail on not finding pythonscad.png. Its because they are named pythonscad-nightly.png .
# In that case do before  AppImage creation create the following links:
# could be    AppDir/usr/local/share/icons/hicolor/128x128/

cd AppDir/usr/share/icons/hicolor/128x128/apps 
ln -s pythonscad-nightly.png  pythonscad.png
cd ../../64x64/apps 
ln -s pythonscad-nightly.png  pythonscad.png
cd ../../256x256/apps 
ln -s pythonscad-nightly.png  pythonscad.png
cd ../../48x48/apps
ln -s pythonscad-nightly.png  pythonscad.png
cd ../../512x512/apps
ln -s pythonscad-nightly.png  pythonscad.png
cd ../../../../../../../                   # Back in the pythonscad directory.                 

###########################################
# To make an AppImage in the pythonscad directory:

. ./scripts/establish_version.sh
export OPENSCAD_VERSION=$(openscad_version)
export OPENSCAD_COMMIT=$(openscad_commit)

# You may need to update the dates 20251107 and 20250213 to get the latest version of:
wget https://github.com/linuxdeploy/linuxdeploy/releases/download/1-alpha-20251107-1/linuxdeploy-x86_64.AppImage
wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/1-alpha-20250213-1/linuxdeploy-plugin-qt-x86_64.AppImage

chmod +x linuxdeploy*

export EXTRA_QT_PLUGINS=svg
export PYTHON_VERSION=$(python3 -c "import sys; v=sys.version_info; print(f'{v.major}.{v.minor}.{v.micro}')")
export LINUXDEPLOY_OUTPUT_VERSION="${PYTHONSCAD_VERSION}${SUFFIX}"

# linuxdeploy-plugin-python.sh is not needed for pythonscad because it does not use Python although there are not used .py files present. 
# Only pythonscad uses Python but then it uses your locally installed Python or venv instead of Python within the AppImage... Ooooo
# ./linuxdeploy-plugin-python.sh --appdir ./AppDir

./linuxdeploy-x86_64.AppImage --list-plugins               # check if plugin qt is 'seen' if so continue.
./linuxdeploy-x86_64.AppImage --plugin qt --output appimage --appdir AppDir

######################################################
# To generate a Linux installer PythonSCAD.tar.gz in the directory where you cloned PythonSCAD (in the pythonscad directory)
# Installs in /usr/local .

# The used release-common.sh is a patched version of the original script, see "Building an installer for linux-gnu fails #6424" on GitHub !!
. ./scripts/establish_version.sh
export OPENSCAD_VERSION=$(openscad_version)
export OPENSCAD_COMMIT=$(openscad_commit)

# Runs on Ubuntu but failed on Mint.
export DEPLOYDIR=./build
./scripts/release-common.sh snapshot    # See LOG_release_common.txt . 

####################################################
####################################################
# See pythonscad issue: Cross compiling with MXE from Linux (Ubuntu) for Windows fails #6421
# Currently this build seems to be broken.......... 
# Currently this build seems to be broken..........
# To build Cross-compile on Linux for Windows:
# Make sure there is no ~/openscad_deps from an openscad build instead of pythonscad...

# python --version
# Ubuntu
#   Python 3.12.3
# Debian:
#   Python 3.13.5

cd
# Environment requirements from https://mxe.cc/#requirements
sudo apt-get install \
    autoconf \
    automake \
    autopoint \
    bash \
    bison \
    bzip2 \
    flex \
    g++ \
    g++-multilib \
    gettext \
    git \
    gperf \
    intltool \
    libc6-dev-i386 \
    libclang-dev \
    libgdk-pixbuf2.0-dev \   # Problem on Debian
#    libgdk-pixbuf-2.0-dev \ # Problem on Ubuntu
    libltdl-dev \
    libgl-dev \
    libpcre2-dev \
    libssl-dev \
    libtool-bin \
    libxml-parser-perl \
    lzip \
    make \
    openssl \
    p7zip-full \
    patch \
    perl \
    python3 \
    python3-mako \
    python3-packaging \
    python3-pkg-resources \
    python3-setuptools \
    python-is-python3 \
    ruby \
    sed \
    sqlite3 \
    unzip \
    wget \
    xz-utils

sudo apt-get install libpcre3 libpcre3-dev libarchive-tools bspatch

# On Linux 
# In addition on Ubuntu maybe more packages are needed :
sudo apt-get install ninja-build
sudo apt-get install itstool nsis libssl-dev libtool    # On Debian install libtool-bin instead (is libtool)
sudo ln -s /usr/bin/libtool /usr/bin/glibtool           # Check first if /usr/bin/libtool is present.

# Kill the xTerm and start with a fresh one.

cd ~/pythonscad

git pull                       # Get the latest code

source ./scripts/setenv-mingw-xbuild.sh 64

./scripts/mingw-x-build-dependencies.sh 64  # Install on Linux any reported "Missing requirement: ..." and repeat this step.
                                            # Creates ~/openscad_deps directory.
                                            # This step fails on clipper2. Remove clipper2 from setenv-mingw-xbuild.sh (twice).
                                            # This takes time, enough for a large meal and a nap.

./scripts/release-common.sh mingw64       # If you have not installed my patches then here it fails on not found package "-  tbb".
                                          # # Added to the packeges lists "download-onetbb" and "onetbb".
                                          # Then is fails on 'file too big' and 'too many sections' which may need flags   -flto -Wl,-allow-multiple-definition
# https://stackoverflow.com/questions/31890021/mingw-too-many-sections-bug-while-compiling-huge-header-file-in-qt   but where...
                                          #
                                          # Get the patches, kill the Xterm and start in a new Xterm with "source ./scripts/setenv-mingw-xbuild.sh 64"
                                          # On Debian it compiles with warnings. See Log files.

# If all goes well there is a  Windows .exe in the current directory.

######################################################
######################################################
# To UnPack an AppImgage with PythonSCAD-2025.12.06.ai29830-x86_64.AppImage in the pythonscad directory

# Check the latest version with a browser on https://files.pythonscad.org/snapshots/
wget -cq https://files.pythonscad.org/snapshots/PythonSCAD-2025.12.06.ai29830-x86_64.AppImage  
chmod u+x PythonSCAD-2025.12.06.ai29830-x86_64.AppImage

# Get the latest AppImage tool to (un)pack an AppImage. 
# WARNING: keep an old working version of the AppImage tool because you may get a buggy continous developped version.
wget -cq https://github.com/AppImage/appimagetool/releases/tag/continuous/appimagetool-x86_64.AppImage
chmod u+x appimagetool-x86_64.AppImage

# Extract pythonscad
./PythonSCAD-2025.12.06.ai29830-x86_64.AppImage --appimage-extract

ls ./squashfs-root   # Directory created by the extract.

# RePack, see Log_appimagetool.txt
# ./appimagetool-x86_64.AppImage ./squashfs-root

######################################################
# Sources to make an AppImage:
# linuxdeploy  https://github.com/linuxdeploy/linuxdeploy/releases/
# Plugins      https://github.com/linuxdeploy/awesome-linuxdeploy    # Get linuxdeploy-plugin-qt and linuxdeploy-plugin-python
# Fails with the python plugin
#
# export PATH=/appimage/usr/bin:"$PATH"
# export EXTRA_QT_PLUGINS=svg
# export PYTHON_VERSION=$(python3 -c "import sys; v=sys.version_info; print(f'{v.major}.{v.minor}.{v.micro}')")
# export LINUXDEPLOY_OUTPUT_VERSION="${PYTHONSCAD_VERSION}${SUFFIX}"
# ./linuxdeploy-x86_64.AppImage --plugin python --plugin qt --output appimage --appdir AppDir
#
###############################################
#mingw-x-build-dependencies.sh
#
#if [ "`echo $* | grep download`" ]; then
#PACKAGES='download-mpfr download-eigen download-opencsg download-cgal download-qtbase download-qtmultimedia download-ninja download-nsis download-glib download-libxml2 download-freetype download-fontconfig download-harfbuzz download-libzip download-lib3mf download-double-conversion download-zip download-onetbb download-curl download-nettle download-pcre download-glm download-nghttp2'
#else
#PACKAGES='qtbase qtmultimedia qscintilla2 mpfr eigen opencsg cgal ninja nsis glib libxml2 freetype fontconfig harfbuzz libzip lib3mf double-conversion zip onetbb curl nettle pcre glm nghttp2'
#fi
