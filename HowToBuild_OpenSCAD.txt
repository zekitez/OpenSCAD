###########################################
#
# In this file I keep my notes on building OpenSCAD with some patches based on Debian (Ubuntu, Mint).
# Building environment: Linux Ubuntu 24.04 Cinnamon (no problem), 
#                       Linux Mint                  (builds but has a problem, see below),
#                       Linux Debian 13.2 Cinnamon  (replacement for Linux Mint) and 
#                       MinGW-w64 on Windows 11.
# Since OpenSCAD is build on Debian, Mint is replaced with Debian 13.2 Cinnamon.
# Cross compiling on Ubuntu for Windows and generating a Windows installer works with some adjustments.
# Building on a Windows machine using MinGW-w64 works. Building a windows installer on MinGW-w64 is not tried.
# During building you will be faced with missing Linux packages. Use Google to find out how to install them.
#
# Just copy line by line and paste each line in an xterm.
#
# Note: While cross compiling on Linux for Windows an ~/openscad_deps is created. 
# The one created for openscad differs from the one for pythonscad.
# They don't mix !!!
#
###########################################
# Get the openscad code:

sudo apt install git wget diffuse                # Needed

git clone https://github.com/openscad/openscad.git
cd openscad
git submodule update --init --recursive

# Install some required packages and check them.
sudo ./scripts/uni-get-dependencies.sh
./scripts/check-dependencies.sh

# In case of missing packages: install them. Use Google to find the correct package name.

#########################################
# Do this step after a 1st succesfull building step and then repeat the building step.
# Get the pached code and overwrite the openscad code.

wget https://github.com/zekitez/OpenSCAD/archive/refs/heads/main.zip
unzip main.zip
# or
git clone https://github.com/zekitez/OpenSCAD.git

tree OpenSCAD
OpenSCAD
├── HowToBuild_OpenSCAD.txt
├── HowToBuild_OpenSCAD_withWindowsMsys.txt
├── HowToBuild_PythonSCAD.txt
├── LICENSE
├── Logs
│   ├── Debian_XcompileWindows_fails.txt
│   ├── Debian_XcompileWindows_success.txt
│   ├── Log_appimagetool.txt
│   ├── Log_cmake_-B_build_-D.txt
│   ├── Log_CompileMingwOnWindows.txt
│   ├── Log_make_install_DESTDIR.txt
│   ├── Log_make_-j8.txt
│   └── Log_release_common.txt
├── openscad
│   ├── CMakeLists.txt                     # Merge !!
│   ├── locale
│   │   ├── cs.po
│   │   ├── de.po
│   │   ├── es.po
│   │   ├── fr.po
│   │   ├── hy.po
│   │   ├── it.po
│   │   ├── ka.po
│   │   ├── openscad.pot
│   │   ├── pl.po
│   │   ├── pt_BR.po
│   │   ├── ru.po
│   │   ├── sv.po
│   │   ├── tr.po
│   │   ├── uk.po
│   │   ├── zh_CN.po
│   │   └── zh_TW.po
│   ├── scripts
│   │   ├── installer-linux.sh
│   │   ├── mingw-x-build-dependencies.sh
│   │   └── release-common.sh
│   └── src
│       └── gui
│           ├── parameter
│           │   ├── ParameterTextArea.cc
│           │   ├── ParameterTextArea.h
│           │   ├── ParameterTextArea.ui
│           │   ├── ParameterText.cc
│           │   ├── ParameterVirtualWidget.h
│           │   ├── ParameterWidget.cc
│           │   ├── ParameterWidget.h
│           │   ├── ParameterWidget.ui
│           │   ├── TextEdit.cc
│           │   └── TextEdit.h
│           ├── Preferences.cc
│           ├── Preferences.h
│           └── Preferences.ui
├── Pictures
│   ├── combobox_details.png
│   ├── designDefault.png
│   ├── designMyPreset_OK.png
│   ├── designMyPreset.png
│   ├── FileDialog.png
│   ├── preferences_curtomizer.png
│   └── TextEdit.png
├── pythonscad
│   └── src
│       └── gui
│           ├── Preferences.cc
│           ├── Preferences.h
│           └── Preferences.ui
└── README.md

# Dangerous but...
cp -rpP OpenSCAD-main/openscad/src/* ./src/.
cp -rpP OpenSCAD-main/openscad/scripts/* ./scripts/
cp -rpP OpenSCAD-main/openscad/locale/* ./locale/

# Check the diff of CMakeLists.txt
# Add to the left   ParameterTextArea.*, TextEdit.* 
# WinMerge or diffuse for differences !!!
diffuse CMakeLists.txt ./OpenSCAD-main/openscad/CMakeLists.txt &

chmod +x ./scripts/*

#########################################
#  Build step for a Linux executable and/or an AppDir for an Linux AppImage building on Linux in the cloned openscad directory:

rm -rf build AppDir
mkdir build

# Get latest files from OpenSCAD master
git pull

# If you did not delete the build then clean it before a new build.
cmake --build build -t clean

# Once only with a new build directory or to change options  do:
cmake -B build \
      -DEXPERIMENTAL=ON \
      -DENABLE_PYTHON=ON \
      -DSNAPSHOT=ON           # See my Log_cmake_-B_build_-D.txt

# Generates an executable which has 66328336 bytes.
# 64780 -rwxrwxr-x  1 db811 db811  66328336 Dec 11 14:04 openscad           <-----
# For a smaller version see below.

# Use 8 cores to make, depends on the CPU cores, 
# Use without the -jn option (slow), or with n = 4 or 6 or ..(faster). See my Log_make_-j8.txt.
cd build
make -j8

# Run from the build directory with:
./openscad

# For generating an AppImage you need to do:
make install DESTDIR=../AppDir    # See Log_make_install_DESTDIR.txt
cd ..

# Optional, install it on this computer with in /usr/bin : 
# sudo cmake --install build

####################################################
#  Build step for a Linux executable and/or an AppDir for an Linux AppImage building on Linux in the cloned openscad directory:

rm -rf build AppDir
mkdir build

# If you did not delete the build then clean it before a new build.
cmake --build build -t clean

# Get latest files from openscad master
git pull

# -DPYTHON_VERSION=3.12  ???

cmake -B build \
  -DCMAKE_INSTALL_PREFIX=/usr \
  -DCMAKE_BUILD_TYPE=Release \    # This option causes compilation with warnings.
#  -DUSE_BUILTIN_OPENCSG=ON \     # Not found
  -DMANIFOLD_PYBIND=OFF \
  -DMANIFOLD_TEST=OFF \
  -DENABLE_PYTHON=ON \
  -DPYTHON_VERSION=3.12 \
#  -DENABLE_TESTS=OFF \           # Not found
  -DEXPERIMENTAL=ON \
  -DSNAPSHOT=ON

cd build
make -j8                        # When your computer has more then 8 cores, otherwise decrease it.

# Generates an executable which has not 66328336 but 19417552 bytes.
# 18964 -rwxrwxr-x  1 db811 db811 19417552 Dec 11 14:13 openscad           <-----

# Run from the build directory with:
./openscad

# For generating an AppImage you need to do:
make install DESTDIR=../AppDir    # See Log_make_install_DESTDIR.txt
cd ..

# Optional, install it on this computer with in /usr/bin : 
# sudo cmake --install build

#######################################
# To make a Linux AppImage in the openscad directory:

. ./scripts/establish_version.sh
export OPENSCAD_VERSION=$(openscad_version)
export OPENSCAD_COMMIT=$(openscad_commit)

# You may need to update the dates 20251107 and 20250213 to get the latest version of:
wget https://github.com/linuxdeploy/linuxdeploy/releases/download/1-alpha-20251107-1/linuxdeploy-x86_64.AppImage
wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/1-alpha-20250213-1/linuxdeploy-plugin-qt-x86_64.AppImage

chmod +x linuxdeploy*

export EXTRA_QT_PLUGINS=svg
export PYTHON_VERSION=$(python3 -c "import sys; v=sys.version_info; print(f'{v.major}.{v.minor}.{v.micro}')")
export LINUXDEPLOY_OUTPUT_VERSION="${OPENSCAD_VERSION}${SUFFIX}"

# linuxdeploy-plugin-python.sh is not needed for openscad because it does not use Python although there are not used .py files present. 
# Only pythonscad uses Python but then it uses your locally installed Python or venv instead of Python within the AppImage.
# ./linuxdeploy-plugin-python.sh --appdir ./AppDir

# Check if plugin qt is 'seen', if so continue.
./linuxdeploy-x86_64.AppImage --list-plugins

# Generate the appimage with:
./linuxdeploy-x86_64.AppImage --plugin qt --output appimage --appdir AppDir

######################################################
# To generate a Linux installer OpenSCAD.tar.gz in the directory where you cloned OpenSCAD (in the openscad directory)
# Installs in /usr/local .

# The used release-common.sh is a patched version of the original script, see "Building an installer for linux-gnu fails #6424" on GitHub !!
. ./scripts/establish_version.sh
export OPENSCAD_VERSION=$(openscad_version)
export OPENSCAD_COMMIT=$(openscad_commit)

chmod +x ./scripts/*

# Runs on Ubuntu but failed on Mint.
export DEPLOYDIR=./build
./scripts/release-common.sh snapshot    # See LOG_release_common.txt . 

# In case of the error: "cp: cannot stat 'openscad': No such file or directory"   do:
ln -s /build/openscad .
./scripts/release-common.sh snapshot

####################################################
####################################################
# See openscad issue: Cross compiling with MXE from Linux (Ubuntu) for Windows fails #6421
# This worked only after adding onetbb to scripts/mingw-x-build-dependencies.sh !!! See patches.
# To build Cross-compile on Linux for Windows install these packages:

# python --version
# Ubuntu
#   Python 3.12.3
# Debian:
#   Python 3.13.5

# Environment requirements from https://mxe.cc/#requirements
sudo apt-get install \
    autoconf \
    automake \
    autopoint \
    bash \
    bison \
    bzip2 \
    flex \
    g++ \
    g++-multilib \
    gettext \
    git \
    gperf \
    intltool \
    libc6-dev-i386 \
    libclang-dev \
#    libgdk-pixbuf2.0-dev \   # Problem on Debian
    libgdk-pixbuf-2.0-dev \   # Problem on Ubuntu
    libltdl-dev \
    libgl-dev \
    libpcre2-dev \
    libssl-dev \
    libtool-bin \
    libxml-parser-perl \
    lzip \
    make \
    openssl \
    p7zip-full \
    patch \
    perl \
    python3 \
    python3-mako \
    python3-packaging \
    python3-pkg-resources \
    python3-setuptools \
    python-is-python3 \
    ruby \
    sed \
    sqlite3 \
    unzip \
    wget \
    xz-utils

# On Linux 
# In addition on Ubuntu more packages maybe needed :
sudo apt-get install ninja-build
sudo apt-get install itstool nsis libssl-dev libtool    # On Debian install libtool-bin instead (is libtool)
sudo ln -s /usr/bin/libtool /usr/bin/glibtool           # Check first if /usr/bin/libtool is present.

# Kill the xTerm and start with a fresh one.

git pull                       # Get the latest code

source ./scripts/setenv-mingw-xbuild.sh 64

./scripts/mingw-x-build-dependencies.sh 64  # Install on Linux any reported "Missing requirement: ..." and repeat this step.
                                            # Creates ~/pythonscad_deps directory.
                                            # This takes time, enough for a large meal and a nap.

./scripts/release-common.sh mingw64       # If you have not installed my patches then here it fails on not found package "-  tbb".
                                          # Get the patches, kill the Xterm and start in a new Xterm with "source ./scripts/setenv-mingw-xbuild.sh 64"
                                          # On Debian it compiles with warnings. See Log files.

# If all goes well there is a  Windows execuatble OpenSCAD*Installer.exe   in the mingw64.static.posix directory.

######################################################
######################################################
# To UnPack an AppImgage with OpenSCAD-2025.12.06.ai29830-x86_64.AppImage in the openscad directory.

# Check the latest version with a browser on https://files.openscad.org/snapshots/
wget -cq https://files.openscad.org/snapshots/OpenSCAD-2025.12.06.ai29830-x86_64.AppImage  
chmod u+x OpenSCAD-2025.12.06.ai29830-x86_64.AppImage

# Get the latest AppImage tool to (un)pack an AppImage. 
# WARNING: keep an old working version of the AppImage tool because you may get a buggy continous developped version.
wget -cq https://github.com/AppImage/appimagetool/releases/tag/continuous/appimagetool-x86_64.AppImage
chmod u+x appimagetool-x86_64.AppImage

# Extract openscad
./OpenSCAD-2025.12.06.ai29830-x86_64.AppImage --appimage-extract

ls ./squashfs-root   # Directory created by the extract.

# RePack, see Log_appimagetool.txt
# ./appimagetool-x86_64.AppImage ./squashfs-root

######################################################
