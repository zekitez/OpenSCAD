###########################################
# Get the openscad code:

git clone https://github.com/openscad/openscad.git
cd openscad
git submodule update --init --recursive

# Install some required packages and check them.
sudo ./scripts/uni-get-dependencies.sh
./scripts/check-dependencies.sh

In case of missing packages: install them.

#########################################
# Merge the patched OpenSCAD code into the cloned openscad directory:
# https://www.funkysi1701.com/posts/2025/merge-two-projects-into-one/

git remote add OpenSCAD https://github.com/zekitez/OpenSCAD.git
git fetch OpenSCAD
git merge OpenSCAD/develop --allow-unrelated-histories --no-ff --no-commit
git reset HEAD README.md
git checkout -- README.md

# Fix merge conflicts and you are done.
# The next 2 lines are needed if you want to push the change to a new branche.
# git checkout -b feature/merge-OpenSCAD-into-openscad
# git push origin feature/merge-OpenSCAD-into-openscad


#########################################
#  Build step for Linux on Linux in the cloned openscad directory:

rm -rf build
mkdir build

# Get latest files from OpenSCAD master
git pull

# If you did not delete the build then clean it before a new build.
cmake --build build -t clean

# Once only with a new build directory or to change options  do:
cmake -B build -DEXPERIMENTAL=ON -DENABLE_PYTHON=ON -DSNAPSHOT=ON    # See my Log_cmake_-B_build_-D.txt

# Use 8 cores to make, depends on the CPU cores, 
# Use without the -jn option (slow), or with n = 4 or 6 or ..(faster). See my Log_make_-j8.txt.
cd build
make -j8

cd ..
# Optional, install it on this computer with: 
# cmake --install build
# or run from the cloned openscad directory with:

./openscad

######################################################
# To generate a Linux installer OpenSCAD.tar.gz in the directory where you cloned OpenSCAD (in the openscad directory)

# The used release-common.sh is a patched version of the original script, see "Building an installer for linux-gnu fails #6424" on GitHub !!

export DEPLOYDIR=./build
./scripts/release-common.sh snapshot    # See LOG_release_common.txt

####################################################
# To build an AppDir for an Linux AppImage on Linux from within an empty directory (in the openscad directory):

rm -rf build
mkdir build

# Get latest files from openscad master
git pull

# -DPYTHON_VERSION=3.12  ???

cmake -B build \
  -DCMAKE_INSTALL_PREFIX=/usr \
  -DCMAKE_BUILD_TYPE=Release \    # This option causes compilation with warnings.
  -DUSE_BUILTIN_OPENCSG=ON \
  -DMANIFOLD_PYBIND=OFF \
  -DMANIFOLD_TEST=OFF \
  -DENABLE_PYTHON=ON \
#  -DPYTHON_VERSION=3.12 \
  -DENABLE_TESTS=OFF \
  -DEXPERIMENTAL=ON \
  -DSNAPSHOT=ON

cd build
make -j8
strip --strip-unneeded openscad
make install DESTDIR=../AppDir    # See Log_make_install_DESTDIR.txt
cd ..

######################################################
# To UnPack and RePack an AppImgage with OpenSCAD-2025.12.06.ai29830-x86_64.AppImage in the openscad directory

# Check the latest version with a browser on https://files.openscad.org/snapshots/
wget -cq https://files.openscad.org/snapshots/OpenSCAD-2025.12.06.ai29830-x86_64.AppImage  
chmod u+x OpenSCAD-2025.12.06.ai29830-x86_64.AppImage

# Get the latest AppImage tool to (un)pack an AppImage. 
# WARNING: keep an old working version of the AppImage tool because you may get a buggy continous developped version.
wget -cq https://github.com/AppImage/appimagetool/releases/tag/continuous/appimagetool-x86_64.AppImage
chmod u+x appimagetool-x86_64.AppImage

# Extract openscad
./OpenSCAD-2025.12.06.ai29830-x86_64.AppImage --appimage-extract

ls ./squashfs-root   # Directory created by the extract.

# RePack, see Log_appimagetool.txt
# ./appimagetool-x86_64.AppImage ./squashfs-root

######################################################
# Sources to make an AppImage:
# linuxdeploy  https://github.com/linuxdeploy/linuxdeploy/releases/
# Plugins      https://github.com/linuxdeploy/awesome-linuxdeploy    # Get linuxdeploy-plugin-qt and linuxdeploy-plugin-python
# Fails with the python plugin
#
# export PATH=/appimage/usr/bin:"$PATH"
# export EXTRA_QT_PLUGINS=svg
# export PYTHON_VERSION=$(python3 -c "import sys; v=sys.version_info; print(f'{v.major}.{v.minor}.{v.micro}')")
# export LINUXDEPLOY_OUTPUT_VERSION="${OPENSCAD_VERSION}${SUFFIX}"
# ./linuxdeploy-x86_64.AppImage --plugin python --plugin qt --output appimage --appdir AppDir

###############################################
# To make an AppImage in the openscad directory:

. ./scripts/establish_version.sh
export OPENSCAD_VERSION=$(openscad_version)
export OPENSCAD_COMMIT=$(openscad_commit)

# You may need to update the dates 20251107 and 20250213 to get the latest version.
wget https://github.com/linuxdeploy/linuxdeploy/releases/download/1-alpha-20251107-1/linuxdeploy-x86_64.AppImage
wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/1-alpha-20250213-1/linuxdeploy-plugin-qt-x86_64.AppImage

chmod +x linux*

export EXTRA_QT_PLUGINS=svg
export PYTHON_VERSION=$(python3 -c "import sys; v=sys.version_info; print(f'{v.major}.{v.minor}.{v.micro}')")
export LINUXDEPLOY_OUTPUT_VERSION="${OPENSCAD_VERSION}${SUFFIX}"

# The next line is not needed for openscad because it does not use Python, 
# only pythonscad uses Python but then it uses your locally installed Python or venv instead of Python within the AppImage.
# ./linuxdeploy-plugin-python.sh --appdir ./AppDir

./linuxdeploy-x86_64.AppImage --list-plugins               # check if plugin qt is 'seen' if so continue.
./linuxdeploy-x86_64.AppImage --plugin qt --output appimage --appdir AppDir

###################################


